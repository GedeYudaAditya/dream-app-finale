{% extends "layouts/main_layout.html" %}

{% block content %}
    <div class="row flex-column-reverse flex-lg-row">
        <div class="col-lg-3 p-0 pt-lg-5" style="height: 100% !important; overflow-y: auto !important;">
            <div class="status-box profil p-3">
                <div class="row py-3 justify-content-center">
                    <div class="col-6 row align-items-center p-0">
                        <div class="col-12">
                            <h4>{{ nama }}</h4>
    
                            <span class="font-so-small text-muted col-12">Email</span>
                            <span class="font-so-small col-12"><b>{{ email }}</b></span>
                        </div>

                        <div class="text-center mt-2 col-12">
                            <a href="{{ url_for('setting') }}" class="btn dream-app btn-primary font-so-small py-1" style="width: 70%;">SETTING AKUN</a>
                            <a href="{{ url_for('logout') }}" class="btn btn-danger font-so-small p-1" style="width: 20%;">
                                <i class="fa fa-sign-out"></i>
                            </a>
                        </div>
                    </div>
                    <div class="col-6 d-flex justify-content-center">
                        <!-- check if image not null -->
                        {% if image %}
                            <img style="height: 147px; width: 147px;" src="{{ url_for('static', filename='uploads/' + image) }}" class="img-fluid img-cover rounded" alt="">
                        {% else %}
                            <img src="{{ url_for('static', filename='img/user.png') }}" style="height: 140px;" class="img-fluid img-cover rounded" alt="">
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="status-box pilih-kamera px-3 py-4">
                
                    <select class="form-select" name="camera_index" id="camera_index" aria-label="Default select example">
                        <option selected disabled>Pilih Kamera</option>
                        <!-- loop -->
                        
                    </select>

                    <div class="text-center mt-2">
                        <button type="button" id="btn_post" value="Start/Stop Recording" class="btn dream-app btn-primary font-small py-1" style="width: 100%;">PROSES</button>
                    </div>
                
            </div>
            <div class="status-box">
                <!-- input file model -->
                <div class="input-group mb-3 input-group-sm px-3 py-4">
                    <label class="input-group-text" for="inputGroupFile02">Upload Model</label>
                    <input type="file" class="form-control form-control-sm" name="model" id="inputGroupFile02" accept=".h5">
                    <!-- <button class="btn btn-outline-secondary" type="button" id="button-addon2">Upload</button> -->
                </div>
            </div>
            <div class="status-box hasil p-3 text-center">
                <h4 class="text-dream-app"><b>HASIL</b></h4>
                <marquee behavior="" direction="" class="text-dream-app">
                    <small class="mb-3">Model : <b id="nama_model">-</b></small>
                </marquee>
                <!-- table -->
                <table class="text-start font-bit-small text-dream-app text-bold">
                    <tr>
                        <td style="width: 120px;">
                            Resolusi Frame
                        </td>
                        <td style="width: 20px;">
                            :
                        </td>
                        <td>
                            888 x 500
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 120px;">
                            Nilai FPS
                        </td>
                        <td style="width: 20px;">
                            :
                        </td>
                        <td id="fps">
                            0
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 120px;">
                            Status
                        </td>
                        <td style="width: 20px;">
                            :
                        </td>
                        <td id="status">
                            -
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 120px;">
                            Derajat
                        </td>
                        <td style="width: 20px;">
                            :
                        </td>
                        <td id="degree">
                            0&deg;
                        </td>
                    </tr>
                </table>
            </div>
            <div class="footer text-center py-3">
                <p class="font-so-small" style="margin: auto;">Copyright Â© Undiksha 2023</p>
            </div>
        </div>
        <div class="col-lg-9 pt-5" style="background-color: rgb(209, 209, 209);">
            <!-- progress bar -->
            <div class="progress p-0 mt-3" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
            </div>

            <!-- <div class="py-3 ps-lg-0 ps-3 pe-3"> -->
            <div class="video-box d-flex justify-content-center align-items-center" style="height: 93%; width: 100%;">
                <!-- <h3 class="text-light">BELUM ADA VIDEO</h3> -->
                <div id="container" style="display: none;">
                    <video autoplay playsinline id="videoElement"></video>
                    <canvas id="canvas" width="400" height="300"></canvas>
                </div>

                <!-- <div class= 'video'> -->
                <img id="photo" style="width: 100% !important; height: 100%;">
                    <!-- <h1>video</h1> -->
                <!-- </div> -->
            </div>
            <!-- </div> -->
        </div>
    </div>

    <script>
        // if file model change
        $('#inputGroupFile02').on('change', function() {
            // get file name
            let fileName = $(this).val().split('\\').pop();
            // change button text
            $(this).next('.custom-file-label').html(fileName);

            // send file to server
            let file = document.getElementById('inputGroupFile02').files[0];
            let formData = new FormData();
            formData.append('model', file);

            // upload and show progress
            $.ajax({
                url: "{{ url_for('upload') }}",
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                xhr: function() {
                    let xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            console.log('Bytes Loaded: ' + e.loaded);
                            console.log('Total Size: ' + e.total);
                            console.log('Percentage Uploaded: ' + (e.loaded / e.total));

                            let percent = Math.round((e.loaded / e.total) * 100);

                            $('#progressBar').attr('aria-valuenow', percent).css('width', percent + '%').text(percent + '%');
                        }
                    });

                    return xhr;
                },
                success: function(data) {
                    console.log(data);
                    // alert(data);
                    Swal.fire({
                        title: "<h1>Attention!</h1>",
                        html: data.model_name + " berhasil diupload",
                        icon: "success",
                        button: "<b>OK</b>",
                        // reload if user click ok
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        allowEnterKey: false,
                        stopKeydownPropagation: false,
                        showConfirmButton: true,
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#3085d6',
                        confirmButtonAriaLabel: 'OK',
                        showCancelButton: false,
                        cancelButtonText: 'Cancel',
                        cancelButtonColor: '#d33',
                        cancelButtonAriaLabel: 'Cancel',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.reload();
                        }
                    });
                },
                error: function(data) {
                    console.log(data);
                    // alert(data);
                    Swal.fire({
                        title: "<h1>Attention!</h1>",
                        html: data.errors,
                        icon: "error",
                        button: "<b>OK</b>",
                    });
                }
            });
            console.log(file);
        });
    </script>
{% endblock %}
